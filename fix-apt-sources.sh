#!/bin/bash

# Script para corrigir repositÃ³rios APT duplicados no Ubuntu
# Resolve o problema: "Target ... is configured multiple times"

echo "ðŸ”§ Corrigindo repositÃ³rios APT duplicados..."

# Fazer backup dos arquivos de sources
echo "ðŸ“‹ Fazendo backup dos sources..."
sudo cp -r /etc/apt/sources.list.d /etc/apt/sources.list.d.backup-$(date +%Y%m%d-%H%M%S)
sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup-$(date +%Y%m%d-%H%M%S)

# Remover arquivo problemÃ¡tico duplicado
if [[ -f "/etc/apt/sources.list.d/ubuntu-mirrors.list" ]]; then
    echo "ðŸ—‘ï¸ Removendo arquivo duplicado ubuntu-mirrors.list..."
    sudo rm -f /etc/apt/sources.list.d/ubuntu-mirrors.list
fi

# Limpar outros arquivos problemÃ¡ticos comuns
sudo rm -f /etc/apt/sources.list.d/*duplicate*
sudo rm -f /etc/apt/sources.list.d/*backup*

# Recriar sources.list limpo para Ubuntu 22.04
echo "ðŸ“ Recriando sources.list limpo..."
sudo tee /etc/apt/sources.list > /dev/null << 'EOF'
# Ubuntu 22.04 LTS (Jammy Jellyfish) - Sources List
# Generated by N.Crisis installer

# Main repository
deb http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ jammy main restricted universe multiverse

# Security updates
deb http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse
deb-src http://security.ubuntu.com/ubuntu/ jammy-security main restricted universe multiverse

# Updates
deb http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ jammy-updates main restricted universe multiverse

# Backports
deb http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
deb-src http://archive.ubuntu.com/ubuntu/ jammy-backports main restricted universe multiverse
EOF

# Remover arquivos de cache corrompidos
echo "ðŸ§¹ Limpando cache APT..."
sudo rm -rf /var/lib/apt/lists/*
sudo rm -rf /var/cache/apt/*.bin

# Recriar cache
echo "ðŸ”„ Atualizando repositÃ³rios..."
sudo apt clean
sudo apt update

echo "âœ… CorreÃ§Ã£o APT concluÃ­da!"
echo "â„¹ï¸ Backups salvos com timestamp para restauraÃ§Ã£o se necessÃ¡rio"

# Verificar se ainda hÃ¡ warnings
echo "ðŸ” Verificando se hÃ¡ warnings restantes..."
if sudo apt update 2>&1 | grep -q "is configured multiple times"; then
    echo "âš ï¸ Ainda existem warnings - executando limpeza adicional..."
    
    # Limpeza mais agressiva
    sudo find /etc/apt/sources.list.d/ -name "*.list" -exec grep -l "jammy" {} \; | while read file; do
        echo "Verificando: $file"
        # Remove duplicatas baseadas no conteÃºdo
        sudo sort "$file" | sudo uniq > "/tmp/$(basename "$file")"
        sudo mv "/tmp/$(basename "$file")" "$file"
    done
    
    sudo apt update
else
    echo "âœ… Nenhum warning encontrado - repositÃ³rios limpos!"
fi